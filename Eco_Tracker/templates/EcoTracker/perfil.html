{% extends 'ecotracker/base.html' %}
{% load static %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/map.css' %}">
{% endblock styles %}

{% block content %}

<div class="row justify-content-center my-4">
    <div class="col-lg-12 col-xl-12">

        <div class="card shadow-sm border-0">
            <div class="card-body p-4 p-md-5">

                <form method="post" action="{% url 'grabar_registro' %}">
                    {% csrf_token %}

                    <div class="row g-4">
                        <!-- COLUMNA IZQUIERDA: FORMULARIO -->
                        <div class="col-lg-5">

                            <div class="card shadow-sm h-100">
                                <div class="card-body">
                                    <h5 class="card-title">Datos de la ecoruta</h5>

                                    <!-- Item utilizado -->
                                    <div class="mb-3">
                                        <label for="item-select" class="form-label">
                                            √çtem utilizado
                                        </label>
                                        <select id="item-select" name="item_id" class="form-select" required>
                                            <option disabled selected>Seleccione un √≠tem...</option>
                                            {% for item in items %}
                                            <option value="{{ item.codigo }}" data-factor="{{ item.factor }}">
                                                {{ item.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <div class="form-text">
                                            Por ejemplo: bicicleta, caminar, transporte p√∫blico, etc.
                                        </div>
                                    </div>

                                    <!-- Tiempo -->
                                    <div class="mb-3">
                                        <label for="time-sec" class="form-label">
                                            Tiempo (seg)
                                        </label>
                                        <input type="number" min="0" step="1" id="time-sec" name="time_sec"
                                            class="form-control">
                                    </div>

                                    <!-- Distancia -->
                                    <div class="mb-3">
                                        <label for="distance-km" class="form-label">
                                            Distancia (km)
                                        </label>
                                        <input type="number" min="0" step="0.01" id="distance-km" name="distance_km"
                                            class="form-control">
                                        <div class="form-text">
                                            Se calcula desde el mapa, pero puedes editarla manualmente.
                                        </div>
                                    </div>

                                    <!-- Huella de carbono en un card con 2 m√©tricas -->
                                    <div class="card shadow-sm mb-3">
                                        <div class="card-body">
                                            <h5 class="card-title mb-3 text-center">Huella de Carbono estimada</h5>

                                            <div class="row text-center">
                                                <div class="col-12 col-md-12 mb-3 mb-md-0 border-md-end">
                                                    <div class="text-muted small fw-bold con_color">Por distancia</div>
                                                    <div id="huella-dist-display" class="display-6 fw-bold">‚Äì</div>
                                                    <div class="small text-muted">kg CO‚ÇÇ</div>
                                                </div>
                                            </div>
                                            <div class="row text-center mt-3">
                                                <div class="col-12 col-md-12 mb-3 mb-md-0 border-md-end">
                                                    <div class="text-muted small fw-bold con_color">Por tiempo</div>
                                                    <div id="huella-time-display" class="display-6 fw-bold">‚Äì</div>
                                                    <div class="small text-muted">kg CO‚ÇÇ</div>
                                                </div>
                                            </div>

                                            <p class="mt-3 mb-0 text-muted small">
                                                Los valores se calculan a partir del √≠tem seleccionado, la distancia y
                                                el tiempo.
                                            </p>
                                        </div>
                                    </div>

                                    <!-- Campos ocultos para enviar al backend si los necesitas -->
                                    <input type="hidden" id="huella-kg-dist" name="huella_distancia">
                                    <input type="hidden" id="huella-kg-time" name="huella_tiempo">
                                </div>
                            </div>

                        </div>

                        <!-- COLUMNA DERECHA: MAPA -->
                        <div class="col-lg-7">
                            <div class="card shadow-sm h-100">
                                <div class="card-body">
                                    <h5 class="card-title">Sugerencias de rutas ecol√≥gicas</h5>

                                    <button id="find-me-btn" type="button" class="btn btn-outline-primary btn-sm mb-2">
                                        üìç Usar mi ubicaci√≥n como inicio
                                    </button>

                                    <small id="map-helper-text" class="form-text text-muted mb-2">
                                        Haz clic en el mapa para elegir un punto de <strong>inicio</strong> y otro de
                                        <strong>t√©rmino</strong>.
                                    </small>

                                    <div id="map" class="map"></div>

                                    <!-- Coordenadas ocultas inicio/fin -->
                                    <input type="hidden" id="start-lat" name="start_lat">
                                    <input type="hidden" id="start-lng" name="start_lng">
                                    <input type="hidden" id="end-lat" name="end_lat">
                                    <input type="hidden" id="end-lng" name="end_lng">
                                </div>
                            </div>
                        </div>

                        <!-- FILA DE BOTONES (OCUPA TODO EL ANCHO) -->
                        <div class="col-12 mt-3">
                            <div class="d-flex flex-wrap gap-2">
                                <button type="submit" name="action" value="save_return" class="btn btn-success" id="btn-save-return" disabled>
                                    Guardar y volver al listado
                                </button>

                                <button type="submit" name="action" value="save_add" class="btn btn-primary" id="btn-save-add" disabled>
                                    Guardar y agregar otra
                                </button>

                                <button type="button" id="clear-form-btn" class="btn btn-outline-secondary">
                                    Limpiar
                                </button>
                            </div>
                        </div>

                    </div> <!-- row -->

                </form>

            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascript %}

<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAh8vAEzFjkQ6OCiTX0FZ1jyC3chTSlU0U&libraries=routes&callback=initMap">
    </script>
<script src="{% static 'js/map.js' %}"></script>
{% endblock javascript %}